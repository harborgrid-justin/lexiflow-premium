import{l as M,r as u,j as i,ac as y,ab as $}from"./vendor-core-V-oW58GW.js";import{D as p}from"./dataService-BWLMkXM4.js";import{u as O,d as P,c as l}from"./useQueryHooks-Oyt-TMLP.js";import{u as k}from"./ThemeContext-OPG61qw5.js";import{u as U}from"./useNotify-DdRjm5G5.js";import{i as V,g as X,h as q}from"./case-detail-q84K17Pa.js";import{T as z,a as B,b as m,c as F,d as A,e as c}from"./Table-C_bcd1kC.js";import{B as b}from"./Button-CDQlLg6j.js";import{b as N}from"./queryKeys-Dex4MaB7.js";import{W as j}from"./type-mappings-DEPYyX4d.js";import"./vendor-misc-Dwkhvdtg.js";import"./vendor-charts-KZIdMATq.js";import"./preload-helper-BXl3LOEh.js";import"./SyncContext-B5_p5hCg.js";import"./Badge-bF-hTHJZ.js";import"./schemas-B2_dy3tf.js";import"./VirtualList-r2WXvtCD.js";import"./AppShell-Cug-APl3.js";import"./tabs.config-D59pmwVC.js";import"./PageHeader-C4TFe3Td.js";import"./formatters-stMuSkc6.js";import"./EmptyState-7A4cJUVU.js";import"./Card-CDOiP5UM.js";import"./MetricCard-BH_9X7pi.js";import"./queryKeys-BBVgMz36.js";import"./useSessionStorage-D_292xEY.js";import"./ErrorState-WL3az5ve.js";import"./ConfirmDialog--jvbqDAw.js";import"./Modal-Rns91qFF.js";import"./Kanban-BI78PbzY.js";import"./dateUtils-rLIRMrtk.js";import"./FilterPanel-BteidCPx.js";import"./AdaptiveLoader-D5wOoiN1.js";import"./UserAvatar-BPVf-Spq.js";import"./Tabs-7xONCRTX.js";import"./Input-Dmln04Yk.js";import"./TextArea-DrtcCAyn.js";import"./geminiService-_CYFbtO8.js";import"./TaskCreationModal-D5xiqN6m.js";import"./search.config-B6mvIgDA.js";import"./useToggle-CjLp2PQ4.js";import"./sanitize-k_Tw3ej1.js";import"./useModalState-Cst_3NmK.js";import"./scheduler-BERajRBE.js";import"./RouteErrorBoundary-Nha8Il06.js";import"./meta-utils-lVs9HXG9.js";const h={MAX_HOURLY_RATE:1e4,MAX_INVOICE_AMOUNT:1e7,MAX_EXPENSE_AMOUNT:1e5,RECEIPT_REQUIRED_THRESHOLD:75,MAX_TRUST_TRANSACTION:1e6,MAX_DECIMAL_PLACES:2,MAX_DAILY_DURATION:1440};function H(e){return isNaN(e)||e<0||e>h.MAX_HOURLY_RATE?!1:(e.toString().split(".")[1]||"").length<=h.MAX_DECIMAL_PLACES}function Q(e){return e>0&&Number.isInteger(e)}function W(e){const s=new Date(e);return!isNaN(s.getTime())}function Y(e){return new Date(e)>new Date}function G(e,s,r){const d=e.trim().length;return d<s?!1:!(d>r)}function K(e,s){return s.includes(e)}function T(e){return e.replace(/<[^>]*>/g,"").replace(/[<>'"]/g,"").trim()}function J(e){const s=[];try{if((!e.caseId||typeof e.caseId!="string")&&s.push("Valid case ID is required"),(!e.userId||typeof e.userId!="string")&&s.push("Valid user ID is required"),(!e.date||!W(e.date))&&s.push("Valid ISO date is required"),e.date&&Y(e.date)&&s.push("Time entry date cannot be in the future"),Q(e.duration)||s.push("Duration must be a positive integer (minutes)"),e.duration>h.MAX_DAILY_DURATION&&s.push(`Duration cannot exceed 24 hours (${h.MAX_DAILY_DURATION} minutes)`),G(e.description,10,500)||(e.description.trim().length<10?s.push("Description must be at least 10 characters (audit requirement)"):s.push("Description cannot exceed 500 characters")),e.rate!==void 0&&!H(e.rate)&&s.push(`Rate must be between $0 and $${h.MAX_HOURLY_RATE} with max 2 decimal places`),e.status&&!K(e.status,Object.values(j))&&s.push(`Invalid status. Must be one of: ${Object.values(j).join(", ")}`),s.length>0)return{valid:!1,errors:s};const r={...e,description:T(e.description),category:e.category?T(e.category):void 0};return{valid:!0,errors:[],sanitized:r}}catch(r){return{valid:!1,errors:[`Validation error: ${r instanceof Error?r.message:"Unknown error"}`]}}}class Z{queue=[];processing=0;maxConcurrent=2;async add(s){return new Promise((r,d)=>{this.queue.push({entries:s,resolve:r,reject:d}),this.processQueue()})}async processQueue(){if(this.processing>=this.maxConcurrent||this.queue.length===0)return;this.processing++;const s=this.queue.shift();if(!s){this.processing--;return}try{const r=s.entries[0].caseId,d="Client Ref "+r,o=await p.billing.createInvoice(d,r,s.entries);s.resolve(o)}catch(r){s.reject(r)}finally{this.processing--,await this.processQueue()}}}const ee=new Z,te=()=>{const{theme:e}=k(),s=U(),[r,d]=u.useState(""),[o,f]=u.useState(new Set),[E]=u.useState(null),{data:I=[]}=O(N.billing.wip(),()=>p&&p.billing?p.billing.getTimeEntries():Promise.resolve([]));V({data:E,onSave:u.useCallback(async t=>{!t||!t.description||localStorage.setItem("billing-wip-draft",JSON.stringify(t))},[]),delay:2e3}),X({"mod+n":()=>{s.info("New time entry form (to be implemented)")},"mod+g":()=>{o.size>0&&S()}});const n=u.useMemo(()=>I.filter(t=>t.status===j.UNBILLED&&(t.description.toLowerCase().includes(r.toLowerCase())||t.caseId.toLowerCase().includes(r.toLowerCase()))),[I,r]),{mutate:v,isLoading:g}=P(async t=>{if(!p||!p.billing)throw new Error("Billing service unavailable");if(t.length===0)throw new Error("No entries selected");const a=[];if(t.forEach((x,L)=>{const w=J(x);w.valid||a.push(`Entry ${L+1}: ${w.errors.join(", ")}`)}),a.length>0)throw s.error(`Validation failed: ${a[0]}`),new Error("Validation failed");return ee.add(t)},{invalidateKeys:[N.billing.wip(),N.billing.invoices()],onSuccess:t=>{if(typeof t=="object"&&t!==null&&"id"in t&&"amount"in t){const a=String(t.id),x=typeof t.amount=="number"?t.amount:0;s.success(`Invoice ${a} generated for $${x.toFixed(2)}`)}else s.success("Invoice generated successfully");f(new Set),localStorage.removeItem("billing-wip-draft")},onError:()=>s.error("Failed to generate invoice.")}),S=u.useCallback(()=>{const t=n.filter(a=>o.has(a.id));if(t.length===0){s.warning("Please select at least one time entry.");return}v(t)},[n,o,v,s]),C=u.useCallback(t=>{const a=new Set(o);a.has(t)?a.delete(t):a.add(t),f(a)},[o]),D=u.useCallback(()=>{o.size===n.length?f(new Set):f(new Set(n.map(t=>t.id)))},[o,n]),_=n.reduce((t,a)=>t+a.total,0),R=n.filter(t=>o.has(t.id)).reduce((t,a)=>t+a.total,0);return i.jsxs("div",{className:"space-y-6 animate-fade-in",children:[i.jsxs("div",{className:l("p-4 rounded-lg border shadow-sm flex flex-col md:flex-row justify-between items-center gap-4",e.surface.default,e.border.default),children:[i.jsxs("div",{children:[i.jsx("h3",{className:l("font-bold text-lg",e.text.primary),children:"Work In Progress"}),i.jsx("p",{className:l("text-sm",e.text.secondary),children:"Review and approve time entries before invoicing."})]}),i.jsxs("div",{className:l("text-right"),children:[i.jsx("p",{className:l("text-xs uppercase font-bold",e.text.tertiary),children:"Total WIP Value"}),i.jsxs("p",{className:l("text-2xl font-mono font-bold text-blue-600"),children:["$",_.toLocaleString(void 0,{minimumFractionDigits:2})]})]})]}),i.jsx(q,{value:r,onChange:d,placeholder:"Search unbilled time...",actions:i.jsxs(b,{variant:"primary",icon:g?void 0:y,onClick:S,disabled:g||o.size===0,children:[g?i.jsx($,{className:"h-4 w-4 animate-spin mr-2"}):null,"Generate Invoice (",o.size,") - $",R.toFixed(2)]})}),i.jsxs(z,{responsive:"card",children:[i.jsxs(B,{children:[i.jsx(m,{className:"w-10",children:i.jsx("input",{type:"checkbox",className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500",checked:n.length>0&&o.size===n.length,onChange:D,"aria-label":"Select all time entries"})}),i.jsx(m,{children:"Date"}),i.jsx(m,{children:"Matter"}),i.jsx(m,{children:"Description"}),i.jsx(m,{className:"text-right",children:"Hours"}),i.jsx(m,{className:"text-right",children:"Rate"}),i.jsx(m,{className:"text-right",children:"Total"}),i.jsx(m,{className:"text-right",children:"Action"})]}),i.jsxs(F,{children:[n.map(t=>i.jsxs(A,{className:o.has(t.id)?"bg-blue-50/50":"",children:[i.jsx(c,{children:i.jsx("input",{type:"checkbox",className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500",checked:o.has(t.id),onChange:()=>C(t.id),"aria-label":`Select time entry for ${t.caseId}`})}),i.jsx(c,{className:l("font-mono text-xs",e.text.secondary),children:t.date}),i.jsx(c,{className:l("font-medium",e.text.primary),children:t.caseId}),i.jsx(c,{className:"max-w-md truncate",children:t.description}),i.jsx(c,{className:"text-right font-bold",children:(t.duration/60).toFixed(1)}),i.jsxs(c,{className:"text-right text-xs text-slate-500",children:["$",t.rate,"/hr"]}),i.jsxs(c,{className:l("text-right font-mono font-bold",e.text.primary),children:["$",t.total.toFixed(2)]}),i.jsx(c,{className:"text-right",children:i.jsxs("div",{className:"flex justify-end gap-2",children:[i.jsx(b,{size:"sm",variant:"ghost",className:"text-blue-600",children:"Edit"}),i.jsx(b,{size:"sm",variant:"ghost",className:"text-red-600",children:"Write-off"})]})})]},t.id)),n.length===0&&i.jsx(A,{children:i.jsx(c,{colSpan:8,className:l("text-center py-8 italic",e.text.tertiary),children:"No unbilled time entries found."})})]})]})]})},We=M.memo(te);export{We as BillingWIP};
