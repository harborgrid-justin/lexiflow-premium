import{r as b,j as e,a_ as F,ab as _,a0 as H,t as V,q as D,T as K,a1 as M,bP as T,u as Q,p as q,v as R,al as W,A as X}from"./vendor-core-V-oW58GW.js";import{u as w,b as y,c as a}from"./useQueryHooks-Oyt-TMLP.js";import{B as G}from"./Badge-bF-hTHJZ.js";import{B as S}from"./Button-CDQlLg6j.js";import{C as N}from"./Card-CDOiP5UM.js";import{E as J}from"./ErrorState-WL3az5ve.js";import{u as Y}from"./ThemeContext-OPG61qw5.js";import{C as x}from"./type-mappings-DEPYyX4d.js";import"./vendor-misc-Dwkhvdtg.js";import"./vendor-charts-KZIdMATq.js";const ue=()=>{const{isDark:s}=Y(),[n,o]=b.useState(""),[g,h]=b.useState("all"),[p,I]=b.useState("30d"),{data:u,isLoading:L,error:$}=w(["matters","all"],()=>y.cases.getAll()),{data:j,isLoading:z}=w(["matters","kpis"],()=>y.cases.getStats()),{data:E}=w(["matters","pipeline"],async()=>{const t=(u||[]).filter(i=>i.status===x.Open||i.status===x.PreFiling);return["Initial Contact","Conflict Check","Engagement Review","Contract Pending"].map((i,v)=>{const l=t.slice(v*Math.floor(t.length/4),(v+1)*Math.floor(t.length/4)),c=l.reduce((m,f)=>m+(f.value||0),0),d=l.length>0?Math.round(l.reduce((m,f)=>{if(!f.createdAt)return m;const B=new Date(f.createdAt);return m+(new Date().getTime()-B.getTime())/(1e3*60*60*24)},0)/l.length):0;return{stage:i,count:l.length,value:c,avgDaysInStage:d,conversionRate:100-v*5}})},{enabled:!!u}),{data:O}=w(["matters","resources",p],async()=>{try{const t=await y.billing.getTimeEntries();return(await y.users.getAll()).map(i=>{const v=(u||[]).filter(m=>m.leadAttorneyId===i.id||m.ownerId===i.id),c=t.filter(m=>m.userId===i.id).reduce((m,f)=>m+(f.duration||0),0),d=180;return{attorneyId:i.id,attorneyName:i.name||i.email,activeMatters:v.length,totalHours:c,utilizationRate:Math.round(c/d*100),capacity:d}})}catch(t){return console.error("Failed to fetch resource utilization:",t),[]}},{enabled:!!u}),{data:k}=w(["matters","activity",p],async()=>{const t=u||[],r=[],i=new Date;return t.forEach(l=>{if(l.trialDate){const d=(new Date(l.trialDate).getTime()-i.getTime())/(1e3*60*60*24);d>=0&&d<=30&&r.push({id:`deadline-${l.id}`,type:"deadline_approaching",matterId:l.id,matterTitle:l.title,description:`Trial in ${Math.ceil(d)} days`,timestamp:new Date(i.getTime()-(30-d)*24*60*60*1e3).toISOString(),priority:d<=7?"high":"medium"})}}),[...t].filter(l=>l.updatedAt||l.createdAt).sort((l,c)=>{const d=new Date(c.updatedAt||c.createdAt),m=new Date(l.updatedAt||l.createdAt);return d.getTime()-m.getTime()}).slice(0,5).forEach(l=>{const c=l.updatedAt||l.createdAt;if(!c)return;const d=new Date(c);i.getTime()-d.getTime()<1440*60*1e3&&r.push({id:`update-${l.id}`,type:"status_change",matterId:l.id,matterTitle:l.title,description:`Status: ${l.status||"Unknown"}`,timestamp:c,priority:"medium"})}),r.sort((l,c)=>new Date(c.timestamp).getTime()-new Date(l.timestamp).getTime()).slice(0,10)},{enabled:!!u}),P=b.useMemo(()=>{if(!u)return[];const t=new Map;return u.forEach(r=>{const i=r.status||"UNKNOWN";t.set(i,(t.get(i)||0)+1)}),Array.from(t.entries()).map(([r,i])=>({status:r,count:i}))},[u]);if(b.useMemo(()=>u?u.filter(t=>{const r=!n||t.title.toLowerCase().includes(n.toLowerCase())||t.caseNumber?.toLowerCase().includes(n.toLowerCase())||t.client?.toLowerCase().includes(n.toLowerCase()),i=g==="all"||t.status===g;return r&&i}):[],[u,n,g]),$)return e.jsx(J,{message:"Failed to load matters data"});const U=L||z;return e.jsxs("div",{className:a("h-full flex flex-col",s?"bg-slate-900":"bg-slate-50"),children:[e.jsx("div",{className:a("border-b px-6 py-4",s?"bg-slate-800 border-slate-700":"bg-white border-slate-200"),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(F,{className:a("absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4",s?"text-slate-400":"text-slate-500")}),e.jsx("input",{type:"text",placeholder:"Search matters by title, number, or client...",value:n,onChange:t=>o(t.target.value),className:a("w-full pl-10 pr-4 py-2 rounded-lg border text-sm",s?"bg-slate-700 border-slate-600 text-slate-100 placeholder-slate-400":"bg-white border-slate-300 text-slate-900 placeholder-slate-500")})]}),e.jsxs("select",{value:g,onChange:t=>h(t.target.value),className:a("px-4 py-2 rounded-lg border text-sm",s?"bg-slate-700 border-slate-600 text-slate-100":"bg-white border-slate-300 text-slate-900"),children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:x.Open,children:"Open"}),e.jsx("option",{value:x.Active,children:"Active"}),e.jsx("option",{value:x.OnHold,children:"On Hold"}),e.jsx("option",{value:x.Closed,children:"Closed"})]}),e.jsxs("select",{value:p,onChange:t=>I(t.target.value),className:a("px-4 py-2 rounded-lg border text-sm",s?"bg-slate-700 border-slate-600 text-slate-100":"bg-white border-slate-300 text-slate-900"),children:[e.jsx("option",{value:"7d",children:"Last 7 Days"}),e.jsx("option",{value:"30d",children:"Last 30 Days"}),e.jsx("option",{value:"90d",children:"Last 90 Days"}),e.jsx("option",{value:"all",children:"All Time"})]})]})}),e.jsx("div",{className:"flex-1 overflow-auto p-6",children:U?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(_,{className:"w-8 h-8 animate-spin text-blue-500"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx(A,{icon:H,title:"Active Matters",value:j?.totalActive||0,change:"+8%",trend:"up",isDark:s}),e.jsx(A,{icon:V,title:"Intake Pipeline",value:j?.intakePipeline||0,change:"+12%",trend:"up",isDark:s}),e.jsx(A,{icon:D,title:"Upcoming Deadlines",value:j?.upcomingDeadlines||0,change:"Next 7 days",isDark:s}),e.jsx(A,{icon:K,title:"At Risk",value:j?.atRisk||0,change:"Needs attention",trend:"down",isDark:s})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(C,{label:"Total Portfolio Value",value:`$${((j?.totalValue||0)/1e6).toFixed(1)}M`,isDark:s}),e.jsx(C,{label:"Team Utilization",value:`${j?.utilizationRate||0}%`,isDark:s}),e.jsx(C,{label:"Avg Matter Age",value:`${j?.averageAge||0} days`,isDark:s}),e.jsx(C,{label:"Conversion Rate",value:`${j?.conversionRate||0}%`,isDark:s})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx(N,{className:"lg:col-span-2",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:a("text-lg font-semibold mb-4",s?"text-slate-100":"text-slate-900"),children:"Intake Pipeline"}),e.jsx("div",{className:"space-y-3",children:E?.map((t,r)=>e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:a("text-sm font-medium",s?"text-slate-300":"text-slate-700"),children:t.stage}),e.jsxs("span",{className:a("text-sm",s?"text-slate-400":"text-slate-600"),children:[t.count," matters"]})]}),e.jsx("div",{className:a("h-2 rounded-full",s?"bg-slate-700":"bg-slate-200"),children:e.jsx("div",{className:"h-full rounded-full bg-gradient-to-r from-blue-500 to-emerald-500",style:{width:`${t.conversionRate}%`}})}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsxs("span",{className:a("text-xs","text-slate-500"),children:["$",(t.value/1e3).toFixed(0),"K • ",t.avgDaysInStage," days avg"]}),e.jsxs("span",{className:a("text-xs","text-slate-500"),children:[t.conversionRate,"% conversion"]})]})]})},r))})]})}),e.jsx(N,{children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:a("text-lg font-semibold mb-4",s?"text-slate-100":"text-slate-900"),children:"Status Distribution"}),e.jsx("div",{className:"space-y-3",children:P.map(({status:t,count:r})=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{status:t}),e.jsx("span",{className:a("text-sm",s?"text-slate-300":"text-slate-700"),children:t})]}),e.jsx(G,{variant:"neutral",children:r})]},t))})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(N,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:a("text-lg font-semibold",s?"text-slate-100":"text-slate-900"),children:"Resource Utilization"}),e.jsxs(S,{variant:"ghost",size:"sm",children:["View All ",e.jsx(M,{className:"w-4 h-4 ml-1"})]})]}),e.jsx("div",{className:"space-y-4",children:O?.map(t=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:a("text-sm font-medium",s?"text-slate-300":"text-slate-700"),children:t.attorneyName}),e.jsxs("div",{className:a("text-xs","text-slate-500"),children:[t.activeMatters," matters • ",t.totalHours,"h / ",t.capacity,"h"]})]}),e.jsxs("div",{className:a("text-sm font-semibold",t.utilizationRate>90?"text-red-500":t.utilizationRate>80?"text-amber-500":"text-emerald-500"),children:[t.utilizationRate,"%"]})]}),e.jsx("div",{className:a("h-2 rounded-full",s?"bg-slate-700":"bg-slate-200"),children:e.jsx("div",{className:a("h-full rounded-full",t.utilizationRate>90?"bg-red-500":t.utilizationRate>80?"bg-amber-500":"bg-emerald-500"),style:{width:`${Math.min(t.utilizationRate,100)}%`}})})]},t.attorneyId))})]})}),e.jsx(N,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:a("text-lg font-semibold",s?"text-slate-100":"text-slate-900"),children:"Recent Activity"}),e.jsxs(S,{variant:"ghost",size:"sm",children:["View All ",e.jsx(M,{className:"w-4 h-4 ml-1"})]})]}),e.jsx("div",{className:"space-y-4",children:k?.map(t=>e.jsxs("div",{className:"flex gap-3",children:[e.jsx(ee,{type:t.type,priority:t.priority}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:a("text-sm font-medium truncate",s?"text-slate-300":"text-slate-700"),children:t.matterTitle}),e.jsx("div",{className:a("text-sm",s?"text-slate-400":"text-slate-600"),children:t.description}),e.jsx("div",{className:a("text-xs mt-1","text-slate-500"),children:te(t.timestamp)})]})]},t.id))})]})})]})]})})]})},A=({icon:s,title:n,value:o,change:g,trend:h,isDark:p})=>e.jsx(N,{className:"p-6",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:a("text-sm font-medium mb-1",p?"text-slate-400":"text-slate-600"),children:n}),e.jsx("div",{className:a("text-3xl font-bold",p?"text-slate-100":"text-slate-900"),children:o.toLocaleString()}),g&&e.jsx("div",{className:a("text-sm mt-2",h==="up"?"text-emerald-500":h==="down"?"text-red-500":p?"text-slate-400":"text-slate-600"),children:g})]}),e.jsx("div",{className:a("p-3 rounded-lg",p?"bg-slate-700":"bg-slate-100"),children:e.jsx(s,{className:a("w-6 h-6",p?"text-blue-400":"text-blue-600")})})]})}),C=({label:s,value:n,isDark:o})=>e.jsxs(N,{className:"p-4",children:[e.jsx("div",{className:a("text-xs font-medium mb-1",o?"text-slate-400":"text-slate-600"),children:s}),e.jsx("div",{className:a("text-xl font-bold",o?"text-slate-100":"text-slate-900"),children:n})]}),Z=({status:s})=>{switch(s){case x.Active:case x.Open:return e.jsx(R,{className:"w-4 h-4 text-emerald-500"});case x.Discovery:case x.Trial:return e.jsx(T,{className:"w-4 h-4 text-blue-500"});case x.OnHold:return e.jsx(q,{className:"w-4 h-4 text-amber-500"});case x.Closed:case x.Settled:return e.jsx(Q,{className:"w-4 h-4 text-slate-400"});default:return e.jsx(T,{className:"w-4 h-4 text-slate-400"})}},ee=({type:s,priority:n})=>{const o=a("w-5 h-5",n==="high"?"text-red-500":n==="medium"?"text-amber-500":"text-slate-400");switch(s){case"deadline_approaching":return e.jsx(D,{className:o});case"status_change":return e.jsx(X,{className:o});case"milestone_reached":return e.jsx(R,{className:o});case"matter_created":return e.jsx(W,{className:o});default:return e.jsx(T,{className:o})}},te=s=>{const n=new Date(s),g=new Date().getTime()-n.getTime(),h=Math.floor(g/6e4);return h<60?`${h}m ago`:h<1440?`${Math.floor(h/60)}h ago`:`${Math.floor(h/1440)}d ago`};export{ue as CaseOverviewDashboard};
