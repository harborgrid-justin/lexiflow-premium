import{r as e}from"./vendor-core-V-oW58GW.js";import{i as R,a as S}from"./useQueryHooks-BdeOvP9e.js";import{D as m}from"./dataService-75QCl8KS.js";import"./ThemeContext-OPG61qw5.js";import{b as H}from"./SyncContext-DYD5yPAv.js";import{u as F}from"./useDomainData-DVGIWLUf.js";import{u as b}from"./useSessionStorage-HC9RvMcM.js";import{P as g}from"./paths.config-lqyvjjOK.js";function W(){const[I,n]=b("lexiflow_active_view",g.DASHBOARD),[d,s]=b("lexiflow_selected_case_id",null),[E,l]=e.useState(null),{addToast:o}=H(),[A,k]=e.useState(!1),[v,x]=e.useState(0),[y]=e.useState(""),[,r]=e.useTransition(),[D,f]=e.useState(void 0),[B,p]=e.useState(!0),[U,w]=e.useState(!1),[_,c]=e.useState("Initializing Secure Data Layer..."),C=e.useRef(!1),{data:h=[]}=F(),z=h[v]||{id:"temp-user",email:"loading@lexiflow.com",firstName:"Loading",lastName:"User",role:"user",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};e.useEffect(()=>{if(C.current)return;C.current=!0,(async()=>{try{if(console.log("[useAppController] Starting initialization..."),R()){c("Connecting to backend API...");try{await S.healthCheck()}catch(i){console.error("Backend health check failed:",i),c("Backend not reachable. Switching to local mode."),localStorage.setItem("VITE_USE_INDEXEDDB","true"),window.location.reload();return}try{if(S.getAuthToken())w(!0);else{c("Authenticating...");const u=await S.post("/auth/login",{email:"admin@lexiflow.com",password:"Demo123!"}),T=u?.accessToken||u?.data?.accessToken,M=u?.refreshToken||u?.data?.refreshToken;if(T)S.setAuthTokens(T,M),w(!0),console.log("✅ Auto-login successful");else throw console.error("❌ Auto-login failed: Invalid response format",u),new Error("Invalid login response")}p(!1)}catch(i){console.error("Authentication failed:",i),c("Authentication failed. Please check backend logs."),p(!1)}}}catch(t){console.error("Initialization failed:",t),c("Error initializing application."),p(!1)}})()},[o]),e.useEffect(()=>{d?(async()=>{try{const t=await m.cases.getById(d);t?l(t):(s(null),o("Case not found or access denied.","warning"))}catch(t){console.error("Failed to restore case context",t)}})():l(null)},[d,s,o]);const O=e.useCallback(a=>{r(async()=>{const t=await m.cases.getById(a);t&&(l(t),s(a),f(void 0),n(g.CASES),o(`Context switched to ${t.title}`,"info"))})},[s,o,n]),L=e.useCallback(a=>{r(()=>{l(null),s(null),n(a),f(void 0),k(!1)})},[n,s]),N=e.useCallback((a,t)=>{r(async()=>{const i=await m.cases.getById(a);i&&(f(t),l(i),s(a),n(g.CASES))})},[s,n]),P=e.useCallback(()=>{r(()=>{h.length>0&&(x(a=>(a+1)%h.length),o("Switched user profile","info"))})},[o,h]),V=e.useCallback(()=>{r(()=>{l(null),s(null),f(void 0),n(g.CASES)})},[s,n]);return{activeView:I,navigateToView:L,selectedCaseId:d,selectedCase:E,selectCase:(a,t)=>{a?t?N(a,t):O(a):V()},currentUser:z,switchUser:P,isSidebarOpen:A,toggleSidebar:()=>k(!A),globalSearch:y,updateSearch:()=>{},isAppLoading:B,isAuthenticated:U,appStatusMessage:_,initialTab:D}}export{W as u};
