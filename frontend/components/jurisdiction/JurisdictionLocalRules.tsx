import React, { useState } from 'react';
import { Plus, Edit2, Trash2, Book } from 'lucide-react';
import { TableContainer, TableHeader, TableBody, TableRow, TableHead, TableCell } from '../common/Table';
import { Button } from '../common/Button';
import { Modal } from '../common/Modal';
import { Input, TextArea } from '../common/Inputs';
import { SearchToolbar } from '../common/SearchToolbar';
import { DataService } from '../../services/data/dataService';
import { LegalRule } from '../../types';
import { Badge } from '../common/Badge';
import { useTheme } from '../../context/ThemeContext';
import { cn } from '../../utils/cn';
import { useModalState } from '../../hooks';
import { useQuery, useMutation, queryClient } from '../../services/infrastructure/queryClient';
import { STORES } from '../../services/data/db';
import { queryKeys } from '../../utils/queryKeys';
import { filterRules } from './utils';

export const JurisdictionLocalRules: React.FC = () => {
  const { theme } = useTheme();
  const [filter, setFilter] = useState('');
  const ruleModal = useModalState();
  const [editingRule, setEditingRule] = useState<Partial<LegalRule>>({});

  // Enterprise Data Access
  const { data: rules = [] } = useQuery<LegalRule[]>(
      [STORES.RULES, 'all'],
      DataService.rules.getAll
  );

  const { mutate: saveRule } = useMutation(
    async (rule: Partial<LegalRule>) => {
        if (rule.id) {
            return DataService.rules.update(rule.id, rule);
        } else {
            return DataService.rules.add({
                id: '', // Auto-generated by service
                code: rule.code!,
                name: rule.name!,
                type: (rule.type as any) || 'Local',
                summary: rule.summary || ''
            });
        }
    },
    {
        invalidateKeys: [[STORES.RULES, 'all']],
        onSuccess: () => {
            ruleModal.close();
            setEditingRule({});
        }
    }
  );

  const { mutate: deleteRule } = useMutation(
      DataService.rules.delete,
      { invalidateKeys: [[STORES.RULES, 'all']] }
  );

  const handleSave = () => {
    if (!editingRule.code || !editingRule.name) return;
    saveRule(editingRule);
  };

  const handleDelete = (id: string) => {
    if (confirm('Are you sure you want to delete this rule definition?')) {
      deleteRule(id);
    }
  };

  const openNew = () => {
    setEditingRule({ type: 'Local' });
    setIsModalOpen(true);
  };

  const openEdit = (rule: LegalRule) => {
    setEditingRule(rule);
    setIsModalOpen(true);
  };

  const filteredRules = filterRules(rules, filter);

  return (
    <div className="space-y-6">
      <SearchToolbar 
        value={filter} 
        onChange={setFilter} 
        placeholder="Search rules (Code, Name, Type)..."
        actions={
            <Button variant="primary" icon={Plus} onClick={openNew}>Add Rule</Button>
        }
      />

      <TableContainer>
        <TableHeader>
          <TableHead>Rule Code</TableHead>
          <TableHead>Type</TableHead>
          <TableHead>Title / Description</TableHead>
          <TableHead>Summary</TableHead>
          <TableHead className="text-right">Actions</TableHead>
        </TableHeader>
        <TableBody>
          {filteredRules.map((r) => (
            <TableRow key={r.id}>
              <TableCell className={cn("font-bold whitespace-nowrap", theme.text.primary)}>{r.code}</TableCell>
              <TableCell>
                  <Badge variant={r.type === 'FRCP' ? 'neutral' : r.type === 'Local' ? 'info' : 'warning'}>{r.type}</Badge>
              </TableCell>
              <TableCell className={theme.primary.text}>
                <div className="flex items-center">
                    <Book className={cn("h-4 w-4 mr-2", theme.text.tertiary)}/> 
                    {r.name}
                </div>
              </TableCell>
              <TableCell className={cn("text-xs max-w-sm truncate", theme.text.secondary)} title={r.summary}>{r.summary}</TableCell>
              <TableCell className="text-right">
                <div className="flex justify-end gap-2">
                    <button onClick={() => openEdit(r)} className={cn("p-1.5 rounded transition-colors", theme.text.secondary, `hover:${theme.primary.text}`, `hover:${theme.surface.highlight}`)}><Edit2 className="h-4 w-4"/></button>
                    <button onClick={() => handleDelete(r.id)} className={cn("p-1.5 rounded transition-colors", theme.text.secondary, `hover:${theme.status.error.text}`, `hover:${theme.status.error.bg}`)}><Trash2 className="h-4 w-4"/></button>
                </div>
              </TableCell>
            </TableRow>
          ))}
          {filteredRules.length === 0 && (
              <TableRow>
                  <TableCell colSpan={5} className={cn("text-center py-8", theme.text.tertiary)}>No rules match your search.</TableCell>
              </TableRow>
          )}
        </TableBody>
      </TableContainer>

      <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={editingRule.id ? "Edit Rule" : "Add New Rule"}>
          <div className="p-6 space-y-4">
              <div className="grid grid-cols-2 gap-4">
                  <Input 
                    label="Rule Code" 
                    placeholder="e.g. L.R. 7-3" 
                    value={editingRule.code || ''}
                    onChange={e => setEditingRule({...editingRule, code: e.target.value})}
                  />
                  <div>
                      <label className={cn("block text-xs font-semibold uppercase mb-1.5", theme.text.secondary)}>Jurisdiction Type</label>
                      <select 
                        className={cn("w-full px-3 py-2 border rounded-md text-sm", theme.surface.default, theme.border.default, theme.text.primary)}
                        value={editingRule.type || 'Local'}
                        onChange={e => setEditingRule({...editingRule, type: e.target.value as any})}
                      >
                          <option value="FRCP">Federal (FRCP)</option>
                          <option value="FRAP">Appellate (FRAP)</option>
                          <option value="FRE">Evidence (FRE)</option>
                          <option value="Local">Local Court Rule</option>
                          <option value="State">State Code</option>
                      </select>
                  </div>
              </div>
              <Input 
                label="Rule Name / Title" 
                placeholder="e.g. Conference of the Parties" 
                value={editingRule.name || ''}
                onChange={e => setEditingRule({...editingRule, name: e.target.value})}
              />
              <TextArea 
                label="Summary / Requirements" 
                rows={4}
                placeholder="Brief summary of the rule's requirement..."
                value={editingRule.summary || ''}
                onChange={e => setEditingRule({...editingRule, summary: e.target.value})}
              />
              <div className={cn("flex justify-end gap-2 pt-4 border-t mt-4", theme.border.default)}>
                  <Button variant="secondary" onClick={() => setIsModalOpen(false)}>Cancel</Button>
                  <Button variant="primary" onClick={handleSave}>Save Rule</Button>
              </div>
          </div>
      </Modal>
    </div>
  );
};
